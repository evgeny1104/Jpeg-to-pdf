<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF-JPEG Конвертер</title>
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#2563eb',
              secondary: '#475569',
            }
          }
        }
      }
    </script>
    
    <!-- PDF & ZIP Utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- React Dependencies & Babel for JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: white; }
        .cursor-wait { cursor: wait; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-white text-slate-800 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Constants ---
        const ConversionMode = {
            PDF_TO_JPEG: 'PDF_TO_JPEG',
            JPEG_TO_PDF: 'JPEG_TO_PDF'
        };

        // --- Utils ---
        
        // PDF to JPEG
        const convertPdfToJpeg = async (file) => {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const pageCount = pdf.numPages;
            const results = [];

            for (let i = 1; i <= pageCount; i++) {
                const page = await pdf.getPage(i);
                // Scale 2.0 for good quality
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                if (!context) continue;

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport,
                }).promise;

                // Quality 0.8 for balance between size and quality
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                const blob = await (await fetch(dataUrl)).blob();

                results.push({
                    name: `${file.name.replace('.pdf', '')}_стр_${i}.jpg`,
                    url: URL.createObjectURL(blob),
                    blob: blob,
                });
            }
            return results;
        };

        // JPEG to PDF
        const convertJpegToPdf = async (files) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const imgData = await readFileAsDataURL(file);
                const imgProps = await getImageProperties(imgData);

                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                
                // Calculate aspect ratio to fit page
                const widthRatio = pdfWidth / imgProps.width;
                const heightRatio = pdfHeight / imgProps.height;
                const ratio = Math.min(widthRatio, heightRatio);
                
                const w = imgProps.width * ratio;
                const h = imgProps.height * ratio;
                
                // Center image
                const x = (pdfWidth - w) / 2;
                const y = (pdfHeight - h) / 2;

                if (i > 0) {
                    doc.addPage();
                }

                doc.addImage(imgData, 'JPEG', x, y, w, h);
            }

            const pdfBlob = doc.output('blob');
            return {
                name: 'converted_document.pdf',
                url: URL.createObjectURL(pdfBlob),
                blob: pdfBlob
            };
        };

        // ZIP Helper
        const createZipFromFiles = async (files) => {
            const zip = new window.JSZip();
            files.forEach(f => {
                zip.file(f.name, f.blob);
            });
            const content = await zip.generateAsync({ type: "blob" });
            return {
                name: "images.zip",
                url: URL.createObjectURL(content),
                blob: content
            };
        };

        const readFileAsDataURL = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const getImageProperties = (url) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.width, height: img.height });
                img.onerror = reject;
                img.src = url;
            });
        };

        // --- Components ---

        const TabButton = ({ isActive, onClick, children }) => (
            <button
                onClick={onClick}
                className={`flex-1 py-2 text-sm font-medium transition-colors duration-200 border-b-2 ${
                isActive
                    ? 'border-blue-600 text-blue-600'
                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                }`}
            >
                {children}
            </button>
        );

        const App = () => {
            const [mode, setMode] = useState(ConversionMode.PDF_TO_JPEG);
            const [files, setFiles] = useState([]);
            const [status, setStatus] = useState('idle'); // idle, processing, success, error
            const [results, setResults] = useState([]);
            const fileInputRef = useRef(null);

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    setFiles(Array.from(e.target.files));
                    setResults([]);
                    setStatus('idle');
                }
            };

            const reset = () => {
                setFiles([]);
                setResults([]);
                setStatus('idle');
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const handleConvert = async () => {
                if (files.length === 0) return;

                setStatus('processing');
                try {
                    if (mode === ConversionMode.PDF_TO_JPEG) {
                        // Assume single PDF for widget simplicity
                        const resultFiles = await convertPdfToJpeg(files[0]);
                        setResults(resultFiles);
                    } else {
                        const resultFile = await convertJpegToPdf(files);
                        setResults([resultFile]);
                    }
                    setStatus('success');
                } catch (error) {
                    console.error(error);
                    setStatus('error');
                }
            };

            const downloadAll = async () => {
                if (results.length === 1) {
                    const link = document.createElement('a');
                    link.href = results[0].url;
                    link.download = results[0].name;
                    link.click();
                } else if (results.length > 1) {
                    const zipResult = await createZipFromFiles(results);
                    const link = document.createElement('a');
                    link.href = zipResult.url;
                    link.download = zipResult.name;
                    link.click();
                }
            };

            return (
                <div className="w-full max-w-[480px] mx-auto p-4 flex flex-col bg-white">
                    {/* Header - h2 used as requested */}
                    <div className="mb-4 text-center">
                        <h2 className="text-xl font-semibold text-slate-800">Конвертер</h2>
                    </div>

                    {/* Tabs */}
                    <div className="flex mb-6 border-b border-slate-200">
                        <TabButton
                            isActive={mode === ConversionMode.PDF_TO_JPEG}
                            onClick={() => { setMode(ConversionMode.PDF_TO_JPEG); reset(); }}
                        >
                            PDF в JPEG
                        </TabButton>
                        <TabButton
                            isActive={mode === ConversionMode.JPEG_TO_PDF}
                            onClick={() => { setMode(ConversionMode.JPEG_TO_PDF); reset(); }}
                        >
                            JPEG в PDF
                        </TabButton>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 flex flex-col items-center space-y-4">
                        
                        {/* Drop/Select Area */}
                        {files.length === 0 && (
                            <div 
                                className="w-full h-32 border-2 border-dashed border-slate-300 rounded-lg flex flex-col items-center justify-center bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer"
                                onClick={() => fileInputRef.current?.click()}
                            >
                                <svg className="w-8 h-8 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <span className="text-sm text-slate-500">
                                    {mode === ConversionMode.PDF_TO_JPEG ? 'Выберите PDF файл' : 'Выберите изображения (JPEG)'}
                                </span>
                            </div>
                        )}

                        {/* File List Preview */}
                        {files.length > 0 && status !== 'success' && (
                            <div className="w-full space-y-2">
                                <div className="bg-slate-50 p-3 rounded-md flex items-center justify-between border border-slate-200">
                                    <div className="flex items-center truncate">
                                        <svg className="w-5 h-5 text-blue-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <span className="text-sm text-slate-700 truncate">
                                            {files.length === 1 ? files[0].name : `Выбрано файлов: ${files.length}`}
                                        </span>
                                    </div>
                                    <button onClick={reset} className="text-slate-400 hover:text-red-500">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <button
                                    onClick={handleConvert}
                                    disabled={status === 'processing'}
                                    className={`w-full py-2 px-4 rounded-md text-white font-medium transition-colors shadow-sm
                                        ${status === 'processing' ? 'bg-blue-400 cursor-wait' : 'bg-blue-600 hover:bg-blue-700'}
                                    `}
                                >
                                    {status === 'processing' ? (
                                        <span className="flex items-center justify-center">
                                            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Обработка...
                                        </span>
                                    ) : (
                                        'Конвертировать'
                                    )}
                                </button>
                            </div>
                        )}

                        {/* Results Area */}
                        {status === 'success' && results.length > 0 && (
                            <div className="w-full text-center space-y-4 animate-fade-in">
                                <div className="p-4 bg-green-50 rounded-lg border border-green-100">
                                    <div className="flex items-center justify-center text-green-600 mb-2">
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <p className="text-sm text-green-800 font-medium">Готово!</p>
                                    <p className="text-xs text-green-600 mt-1">
                                        {results.length} файл(ов) создано
                                    </p>
                                </div>

                                <button 
                                    onClick={downloadAll}
                                    className="w-full py-2 px-4 bg-slate-800 text-white rounded-md hover:bg-slate-700 font-medium transition-colors flex items-center justify-center"
                                >
                                    <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Скачать {results.length > 1 ? 'архивом' : 'файл'}
                                </button>

                                <button onClick={reset} className="text-xs text-slate-400 hover:text-slate-600 underline">
                                    Начать заново
                                </button>
                            </div>
                        )}
                        
                        {status === 'error' && (
                            <div className="w-full p-3 bg-red-50 text-red-600 text-sm rounded-md text-center border border-red-100">
                                Произошла ошибка при конвертации.
                                <button onClick={reset} className="block w-full mt-2 text-xs font-semibold underline">Попробовать снова</button>
                            </div>
                        )}

                    </div>

                    {/* Hidden Inputs */}
                    <input
                        type="file"
                        ref={fileInputRef}
                        onChange={handleFileChange}
                        accept={mode === ConversionMode.PDF_TO_JPEG ? "application/pdf" : "image/jpeg, image/jpg"}
                        multiple={mode === ConversionMode.JPEG_TO_PDF}
                        className="hidden"
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>