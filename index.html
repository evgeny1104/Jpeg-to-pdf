<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF-JPEG Конвертер</title>
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#2563eb',
              secondary: '#475569',
            }
          }
        }
      }
    </script>
    
    <!-- PDF & ZIP Utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- React Dependencies & Babel for JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: white; }
        .cursor-wait { cursor: wait; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        /* Custom scrollbar for image grid */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-white text-slate-800 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Constants ---
        const ConversionMode = {
            PDF_TO_JPEG: 'PDF_TO_JPEG',
            JPEG_TO_PDF: 'JPEG_TO_PDF'
        };

        // --- Utils ---
        
        // PDF to JPEG
        const convertPdfToJpeg = async (file) => {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const pageCount = pdf.numPages;
            const results = [];

            for (let i = 1; i <= pageCount; i++) {
                const page = await pdf.getPage(i);
                // Scale 2.0 for good quality
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                if (!context) continue;

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport,
                }).promise;

                // Quality 0.8 for balance between size and quality
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                const blob = await (await fetch(dataUrl)).blob();

                results.push({
                    name: `${file.name.replace('.pdf', '')}_стр_${i}.jpg`,
                    url: URL.createObjectURL(blob),
                    blob: blob,
                });
            }
            return results;
        };

        // JPEG to PDF
        const convertJpegToPdf = async (orderedFiles) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Process files in order
            for (let i = 0; i < orderedFiles.length; i++) {
                const file = orderedFiles[i].file; // Extract File object from wrapper
                const imgData = await readFileAsDataURL(file);
                const imgProps = await getImageProperties(imgData);

                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                
                // Calculate aspect ratio to fit page
                const widthRatio = pdfWidth / imgProps.width;
                const heightRatio = pdfHeight / imgProps.height;
                const ratio = Math.min(widthRatio, heightRatio);
                
                const w = imgProps.width * ratio;
                const h = imgProps.height * ratio;
                
                // Center image
                const x = (pdfWidth - w) / 2;
                const y = (pdfHeight - h) / 2;

                if (i > 0) {
                    doc.addPage();
                }

                doc.addImage(imgData, 'JPEG', x, y, w, h);
            }

            const pdfBlob = doc.output('blob');
            return {
                name: 'document.pdf',
                url: URL.createObjectURL(pdfBlob),
                blob: pdfBlob
            };
        };

        // ZIP Helper
        const createZipFromFiles = async (files) => {
            const zip = new window.JSZip();
            files.forEach(f => {
                zip.file(f.name, f.blob);
            });
            const content = await zip.generateAsync({ type: "blob" });
            return {
                name: "images.zip",
                url: URL.createObjectURL(content),
                blob: content
            };
        };

        const readFileAsDataURL = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const getImageProperties = (url) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.width, height: img.height });
                img.onerror = reject;
                img.src = url;
            });
        };

        // --- Components ---

        const TabButton = ({ isActive, onClick, children }) => (
            <button
                onClick={onClick}
                className={`flex-1 py-2 text-sm font-medium transition-colors duration-200 border-b-2 ${
                isActive
                    ? 'border-blue-600 text-blue-600'
                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                }`}
            >
                {children}
            </button>
        );

        const App = () => {
            const [mode, setMode] = useState(ConversionMode.PDF_TO_JPEG);
            const [files, setFiles] = useState([]); // Raw files (for PDF mode)
            const [orderedImages, setOrderedImages] = useState([]); // For JPEG mode: { id, file, url }
            const [status, setStatus] = useState('idle'); // idle, processing, success, error
            const [results, setResults] = useState([]);
            const fileInputRef = useRef(null);
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            // Clean up URLs on unmount or reset
            useEffect(() => {
                return () => {
                    orderedImages.forEach(img => URL.revokeObjectURL(img.url));
                };
            }, []);

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    let selectedFiles = Array.from(e.target.files);
                    
                    if (mode === ConversionMode.JPEG_TO_PDF) {
                        if (selectedFiles.length > 30) {
                            alert('Можно загрузить не более 30 файлов. Будут обработаны первые 30.');
                            selectedFiles = selectedFiles.slice(0, 30);
                        }
                        // Create preview objects
                        const newImages = selectedFiles.map(file => ({
                            id: Math.random().toString(36).substr(2, 9),
                            file: file,
                            url: URL.createObjectURL(file)
                        }));
                        setOrderedImages(newImages);
                    } else {
                        setFiles(selectedFiles);
                    }

                    setResults([]);
                    setStatus('idle');
                }
            };

            const reset = () => {
                // Clean up existing blob URLs
                orderedImages.forEach(img => URL.revokeObjectURL(img.url));
                setFiles([]);
                setOrderedImages([]);
                setResults([]);
                setStatus('idle');
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            // Drag and Drop Handlers
            const onDragStart = (e, index) => {
                dragItem.current = index;
                e.dataTransfer.effectAllowed = "move";
                // Make the drag image a bit transparent? Browser handles this mostly.
            };

            const onDragEnter = (e, index) => {
                dragOverItem.current = index;
                e.preventDefault();
            };

            const onDragEnd = () => {
                const startIdx = dragItem.current;
                const endIdx = dragOverItem.current;

                if (startIdx !== null && endIdx !== null && startIdx !== endIdx) {
                    const newItems = [...orderedImages];
                    const draggedItem = newItems[startIdx];
                    newItems.splice(startIdx, 1);
                    newItems.splice(endIdx, 0, draggedItem);
                    setOrderedImages(newItems);
                }

                dragItem.current = null;
                dragOverItem.current = null;
            };

            const onDragOver = (e) => {
                e.preventDefault();
            }

            const handleConvert = async () => {
                if (mode === ConversionMode.PDF_TO_JPEG && files.length === 0) return;
                if (mode === ConversionMode.JPEG_TO_PDF && orderedImages.length === 0) return;

                setStatus('processing');
                try {
                    if (mode === ConversionMode.PDF_TO_JPEG) {
                        const resultFiles = await convertPdfToJpeg(files[0]);
                        setResults(resultFiles);
                    } else {
                        // Pass the ordered list of image wrappers
                        const resultFile = await convertJpegToPdf(orderedImages);
                        setResults([resultFile]);
                    }
                    setStatus('success');
                } catch (error) {
                    console.error(error);
                    setStatus('error');
                }
            };

            const downloadAll = async () => {
                if (results.length === 1) {
                    const link = document.createElement('a');
                    link.href = results[0].url;
                    link.download = results[0].name;
                    link.click();
                } else if (results.length > 1) {
                    const zipResult = await createZipFromFiles(results);
                    const link = document.createElement('a');
                    link.href = zipResult.url;
                    link.download = zipResult.name;
                    link.click();
                }
            };

            const hasFiles = (mode === ConversionMode.PDF_TO_JPEG && files.length > 0) || 
                           (mode === ConversionMode.JPEG_TO_PDF && orderedImages.length > 0);

            return (
                <div className="w-full max-w-[480px] mx-auto p-4 flex flex-col bg-white">
                    {/* Header */}
                    <div className="mb-4 text-center">
                        <h2 className="text-xl font-semibold text-slate-800">Конвертер</h2>
                    </div>

                    {/* Tabs */}
                    <div className="flex mb-6 border-b border-slate-200">
                        <TabButton
                            isActive={mode === ConversionMode.PDF_TO_JPEG}
                            onClick={() => { setMode(ConversionMode.PDF_TO_JPEG); reset(); }}
                        >
                            PDF в JPEG
                        </TabButton>
                        <TabButton
                            isActive={mode === ConversionMode.JPEG_TO_PDF}
                            onClick={() => { setMode(ConversionMode.JPEG_TO_PDF); reset(); }}
                        >
                            JPEG в PDF
                        </TabButton>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 flex flex-col items-center space-y-4">
                        
                        {/* Drop/Select Area - Show only if no files selected */}
                        {!hasFiles && (
                            <div 
                                className="w-full h-32 border-2 border-dashed border-slate-300 rounded-lg flex flex-col items-center justify-center bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer"
                                onClick={() => fileInputRef.current?.click()}
                            >
                                <svg className="w-8 h-8 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <span className="text-sm text-slate-500">
                                    {mode === ConversionMode.PDF_TO_JPEG ? 'Выберите PDF файл' : 'Выберите JPEG (до 30 шт)'}
                                </span>
                            </div>
                        )}

                        {/* Selected Files / Preview Area */}
                        {hasFiles && status !== 'success' && (
                            <div className="w-full space-y-4">
                                
                                {/* Header for file list */}
                                <div className="flex justify-between items-center px-1">
                                    <span className="text-sm font-medium text-slate-700">
                                        {mode === ConversionMode.PDF_TO_JPEG 
                                            ? `Файл: ${files[0]?.name}`
                                            : `Выбрано изображений: ${orderedImages.length}`
                                        }
                                    </span>
                                    <button onClick={reset} className="text-xs text-red-500 hover:text-red-700 underline">
                                        Сбросить
                                    </button>
                                </div>

                                {/* PDF Preview (Simple) */}
                                {mode === ConversionMode.PDF_TO_JPEG && (
                                    <div className="bg-slate-50 p-4 rounded border border-slate-200 flex items-center justify-center">
                                         <svg className="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                )}

                                {/* JPEG Grid Sortable */}
                                {mode === ConversionMode.JPEG_TO_PDF && (
                                    <div className="w-full">
                                        <p className="text-xs text-slate-500 mb-2 text-center">Перетащите, чтобы изменить порядок</p>
                                        <div className="grid grid-cols-3 gap-2 max-h-[300px] overflow-y-auto custom-scrollbar p-1 bg-slate-50 rounded border border-slate-200">
                                            {orderedImages.map((item, index) => (
                                                <div
                                                    key={item.id}
                                                    draggable
                                                    onDragStart={(e) => onDragStart(e, index)}
                                                    onDragEnter={(e) => onDragEnter(e, index)}
                                                    onDragEnd={onDragEnd}
                                                    onDragOver={onDragOver}
                                                    className="relative aspect-square bg-white border border-slate-300 rounded overflow-hidden cursor-move hover:shadow-md transition-shadow group"
                                                >
                                                    <img src={item.url} alt={`Page ${index + 1}`} className="w-full h-full object-cover pointer-events-none" />
                                                    <div className="absolute top-0 left-0 bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded-br">
                                                        {index + 1}
                                                    </div>
                                                    <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all pointer-events-none"></div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Action Button */}
                                <button
                                    onClick={handleConvert}
                                    disabled={status === 'processing'}
                                    className={`w-full py-2 px-4 rounded-md text-white font-medium transition-colors shadow-sm
                                        ${status === 'processing' ? 'bg-blue-400 cursor-wait' : 'bg-blue-600 hover:bg-blue-700'}
                                    `}
                                >
                                    {status === 'processing' ? (
                                        <span className="flex items-center justify-center">
                                            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Обработка...
                                        </span>
                                    ) : (
                                        'Конвертировать'
                                    )}
                                </button>
                            </div>
                        )}

                        {/* Results Area */}
                        {status === 'success' && results.length > 0 && (
                            <div className="w-full text-center space-y-4 animate-fade-in">
                                <div className="p-4 bg-green-50 rounded-lg border border-green-100">
                                    <div className="flex items-center justify-center text-green-600 mb-2">
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <p className="text-sm text-green-800 font-medium">Готово!</p>
                                    <p className="text-xs text-green-600 mt-1">
                                        {results.length} файл(ов) создано
                                    </p>
                                </div>

                                <button 
                                    onClick={downloadAll}
                                    className="w-full py-2 px-4 bg-slate-800 text-white rounded-md hover:bg-slate-700 font-medium transition-colors flex items-center justify-center"
                                >
                                    <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Скачать {results.length > 1 ? 'архивом' : 'файл'}
                                </button>

                                <button onClick={reset} className="text-xs text-slate-400 hover:text-slate-600 underline">
                                    Начать заново
                                </button>
                            </div>
                        )}
                        
                        {status === 'error' && (
                            <div className="w-full p-3 bg-red-50 text-red-600 text-sm rounded-md text-center border border-red-100">
                                Произошла ошибка при конвертации.
                                <button onClick={reset} className="block w-full mt-2 text-xs font-semibold underline">Попробовать снова</button>
                            </div>
                        )}

                    </div>

                    {/* Hidden Inputs */}
                    <input
                        type="file"
                        ref={fileInputRef}
                        onChange={handleFileChange}
                        accept={mode === ConversionMode.PDF_TO_JPEG ? "application/pdf" : "image/jpeg, image/jpg"}
                        multiple={mode === ConversionMode.JPEG_TO_PDF}
                        className="hidden"
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>